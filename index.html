<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Welcome to kkb blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="个人简单记录一下学习">
<meta property="og:type" content="website">
<meta property="og:title" content="Welcome to kkb blog">
<meta property="og:url" content="https://kkb-1.github.io/index.html">
<meta property="og:site_name" content="Welcome to kkb blog">
<meta property="og:description" content="个人简单记录一下学习">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="kkb">
<meta property="article:tag" content="blog">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Welcome to kkb blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Welcome to kkb blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">笑口常开， cheap man 自然 lang</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://kkb-1.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-减少工具-token-操作" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/12/05/%E5%87%8F%E5%B0%91%E5%B7%A5%E5%85%B7-token-%E6%93%8D%E4%BD%9C/" class="article-date">
  <time class="dt-published" datetime="2025-12-05T14:48:37.000Z" itemprop="datePublished">2025-12-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/12/05/%E5%87%8F%E5%B0%91%E5%B7%A5%E5%85%B7-token-%E6%93%8D%E4%BD%9C/">减少工具 token 操作</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h1><p>我们知道，工具的定义和调用结果很“占 token”，一个工具还好，但是我们会用到的工具一般都很多，而且有时候不知道是要用哪个，很难按需使用，导致光是工具的定义就可以撑包上下文，以及对数据格式的规范定义边界模糊。</p>
<p>但是 claude 为我们提供了 3 种解决思路（Tool Search Tool、Programmatic Tool Calling、Tool Use Examples）</p>
<h1 id="2-Tool-Search-Tool"><a href="#2-Tool-Search-Tool" class="headerlink" title="2. Tool Search Tool"></a>2. Tool Search Tool</h1><p>针对「工具定义 token 爆炸」、「按需使用」痛点，claude 提供了 Tool Search Tool 的方案：</p>
<ul>
<li>提供的工具箱中，用<code>defer_loading: true</code>，在上下文中隐藏部分工具（这些工具一般是按需使用的工具，并不需要时时刻刻都加载入上下文）</li>
<li><code>defer_loading: false</code>：不需要隐藏的工具，也就是常用的小工具，可以一开始就载入上下文中</li>
</ul>
<h2 id="2-1-如何让隐藏的工具按需载入？"><a href="#2-1-如何让隐藏的工具按需载入？" class="headerlink" title="2.1. 如何让隐藏的工具按需载入？"></a>2.1. 如何让隐藏的工具按需载入？</h2><p>工具箱中有一个小工具，它的功能是模糊匹配查找需要的工具。</p>
<p>这么说应该就比较懂了。</p>
<p>举例：claude 发现自己可能需要用到 github 相关的工具，那么他就会用这个查找小工具，查找 github ，小工具会去工具箱中找 github 关键词匹配的工具出来给 claude 使用。</p>
<h1 id="3-Programmatic-Tool-Calling"><a href="#3-Programmatic-Tool-Calling" class="headerlink" title="3. Programmatic Tool Calling"></a>3. Programmatic Tool Calling</h1><p>针对「工具调用结果 token 爆炸」痛点，采取了以下方案：</p>
<ul>
<li>Claude 通过编写脚本去编排和调用工具，并控制最终结果输出的内容格式。</li>
<li>Claude 只会看到了脚本处理后的结果，而不是完整的工具调用结果，抛弃了无用的信息，减少了 token</li>
<li>Claude 从始至终都是在进行沙盒操作</li>
</ul>
<h1 id="4-Tool-Use-Examples"><a href="#4-Tool-Use-Examples" class="headerlink" title="4. Tool Use Examples"></a>4. Tool Use Examples</h1><p>针对「数据格式的规范定义边界模糊」的情况，claude 也有提供方案，不过在此之前，先解释一下，为什么要关心这个边界模糊问题。</p>
<h2 id="4-1-格式边界模糊会带来的问题"><a href="#4-1-格式边界模糊会带来的问题" class="headerlink" title="4.1. 格式边界模糊会带来的问题"></a>4.1. 格式边界模糊会带来的问题</h2><p>假设工具的响应结果中有时间，那么，这个是“2024-11-06”、“Nov 6， 2024”还是“2024-11-06T00：00：00Z”？</p>
<p>这种歧义可能会影响 claude 的脚本的中间处理过程，导致 claude 最终得到的结果出现偏差，并且由于脚本沙盒的原因， claude 无法确认这个结果是否发生偏差了。</p>
<h2 id="4-2-具体方案"><a href="#4-2-具体方案" class="headerlink" title="4.2. 具体方案"></a>4.2. 具体方案</h2><p>以下是示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;create_ticket&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;input_schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">/* same schema as above */</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;input_examples&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Login page returns 500 error&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;priority&quot;</span><span class="punctuation">:</span> <span class="string">&quot;critical&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;bug&quot;</span><span class="punctuation">,</span> <span class="string">&quot;authentication&quot;</span><span class="punctuation">,</span> <span class="string">&quot;production&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reporter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;USR-12345&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jane Smith&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;contact&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jane@acme.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;+1-555-0123&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;due_date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-11-06&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;escalation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;notify_manager&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;sla_hours&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Add dark mode support&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;feature-request&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ui&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reporter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;USR-67890&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Alex Chen&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Update API documentation&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>通过 <code>input_examples</code>可以让 claude 知道数据格式具体是什么样的</p>
<h1 id="5-并不是-3-种方案都必须严格执行"><a href="#5-并不是-3-种方案都必须严格执行" class="headerlink" title="5. 并不是 3 种方案都必须严格执行"></a>5. 并不是 3 种方案都必须严格执行</h1><p>刚刚提到的 3 种方案并不代表一定要无时无刻都要实现，仅当你需要的时候才去采取这个方案。</p>
<ul>
<li>工具搜索工具的上下文膨胀 → Tool Search Tool</li>
<li>大型中间结果污染上下文 → Programmatic Tool Calling</li>
<li>参数错误和错误调用 → Tool Use Examples</li>
</ul>
<p>不然你会很麻烦，比如Tool Use Examples，如果所有工具都要提供例子，那 token 一样会爆炸，仅仅当你需要举例让 claude 排除歧义的时候使用。</p>
<h1 id="6-参考文献"><a href="#6-参考文献" class="headerlink" title="6. 参考文献"></a>6. 参考文献</h1><p><a target="_blank" rel="noopener" href="https://www.anthropic.com/engineering/advanced-tool-use">https://www.anthropic.com/engineering/advanced-tool-use</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kkb-1.github.io/2025/12/05/%E5%87%8F%E5%B0%91%E5%B7%A5%E5%85%B7-token-%E6%93%8D%E4%BD%9C/" data-id="cmiszeshn00001kkdhrbfawpg" data-title="减少工具 token 操作" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ai%E6%8F%90%E6%95%88/" rel="tag">ai提效</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-基于-AGUI-和-MCP-实现端-Tool" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/11/26/%E5%9F%BA%E4%BA%8E-AGUI-%E5%92%8C-MCP-%E5%AE%9E%E7%8E%B0%E7%AB%AF-Tool/" class="article-date">
  <time class="dt-published" datetime="2025-11-26T06:27:40.000Z" itemprop="datePublished">2025-11-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/11/26/%E5%9F%BA%E4%BA%8E-AGUI-%E5%92%8C-MCP-%E5%AE%9E%E7%8E%B0%E7%AB%AF-Tool/">基于 AGUI 和 MCP 实现端 Tool</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="1-概念解析"><a href="#1-概念解析" class="headerlink" title="1. 概念解析"></a>1. 概念解析</h1><blockquote>
<p>AGUI</p>
</blockquote>
<p>是 Agent 与前端&#x2F;客户端应用进行交互的一个通用通讯协议</p>
<blockquote>
<p>MCP</p>
</blockquote>
<p>是 LLM 远程调用 Tool 的一个通用协议</p>
<blockquote>
<p>端 Tool</p>
</blockquote>
<p>类似于 MCP 的 Stdio 版，就是用户端自行定义 Tool ，通过一定手段让远端的 Agent 可以调用用户端能力，包括远程操控浏览器等骚操作。</p>
<h1 id="2-实现方式"><a href="#2-实现方式" class="headerlink" title="2. 实现方式"></a>2. 实现方式</h1><p>在远端 Agent 架起一个空 MCP Server ，而 MCP Server 内部是 AGUI ，当用户端连上远端 Agent 之后，MCP Server 通过 AGUI 协议向用户端发送 tool&#x2F;list 和 tool&#x2F;call 元数据，用户端通过 AGUI 协议返回对应的响应结果，当然这一环节的响应请求格式都是符合 AGUI 协议的，而非 MCP 协议。</p>
<p>当数据来到 MCP Server 时， MCP Server 将数据改造成 MCP 协议格式扔出去给 LLM 使用。</p>
<h1 id="3-流程示例如下"><a href="#3-流程示例如下" class="headerlink" title="3. 流程示例如下"></a>3. 流程示例如下</h1><h3 id="3-1-LLM-侧发起工具调用"><a href="#3-1-LLM-侧发起工具调用" class="headerlink" title="3.1. LLM 侧发起工具调用"></a>3.1. LLM 侧发起工具调用</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tools/call&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;agui_user_confirm&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;arguments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;转账确认&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span> <span class="string">&quot;向 0x9c...b3ef 转 100 USDT？&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ok_text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;确认转账&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cancel_text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;再想想&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-agui-mcp-server-收到后-→-把参数包装成-AG-UI-事件"><a href="#3-2-agui-mcp-server-收到后-→-把参数包装成-AG-UI-事件" class="headerlink" title="3.2. agui-mcp-server 收到后 → 把参数包装成 AG-UI 事件"></a>3.2. agui-mcp-server 收到后 → 把参数包装成 AG-UI 事件</h3><p>AGUI 事件名【agui.tool.invoke】</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /agui/events?<span class="built_in">id</span>=3</span><br><span class="line">Content-Type: text/event-stream</span><br><span class="line"></span><br><span class="line">event: agui.tool.invoke</span><br><span class="line">data: &#123;</span><br><span class="line">  <span class="string">&quot;call_id&quot;</span>: <span class="string">&quot;3&quot;</span>,                       // 与 MCP jsonrpc <span class="built_in">id</span> 保持一致</span><br><span class="line">  <span class="string">&quot;tool&quot;</span>: <span class="string">&quot;agui_user_confirm&quot;</span>,</span><br><span class="line">  <span class="string">&quot;params&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;转账确认&quot;</span>,</span><br><span class="line">    <span class="string">&quot;body&quot;</span>: <span class="string">&quot;向 0x9c...b3ef 转 100 USDT？&quot;</span>,</span><br><span class="line">    <span class="string">&quot;okText&quot;</span>: <span class="string">&quot;确认转账&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cancelText&quot;</span>: <span class="string">&quot;再想想&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-端侧（Web）收到事件-→-渲染弹窗"><a href="#3-3-端侧（Web）收到事件-→-渲染弹窗" class="headerlink" title="3.3. 端侧（Web）收到事件 → 渲染弹窗"></a>3.3. 端侧（Web）收到事件 → 渲染弹窗</h3><p>AGUI 事件名【agui.tool.return】</p>
<p>用户点击 “确认转账” 后，前端把结果写回：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WebSocket SEND<span class="punctuation">:</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;agui.tool.return&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;call_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-agui-mcp-server-把前端回包转成-MCP-CallToolResult"><a href="#3-4-agui-mcp-server-把前端回包转成-MCP-CallToolResult" class="headerlink" title="3.4. agui-mcp-server 把前端回包转成 MCP CallToolResult"></a>3.4. agui-mcp-server 把前端回包转成 MCP CallToolResult</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后交付给 LLM</p>
<p>End.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kkb-1.github.io/2025/11/26/%E5%9F%BA%E4%BA%8E-AGUI-%E5%92%8C-MCP-%E5%AE%9E%E7%8E%B0%E7%AB%AF-Tool/" data-id="cmifmk44y0000l9kd87d7g336" data-title="基于 AGUI 和 MCP 实现端 Tool" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aigc-backend/" rel="tag">aigc backend</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-coze-loop" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/11/25/coze-loop/" class="article-date">
  <time class="dt-published" datetime="2025-11-25T06:56:06.000Z" itemprop="datePublished">2025-11-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/11/25/coze-loop/">coze loop</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h1><p>跟着团队去开发 AI 应用时，经常会遇到如下情景：</p>
<ul>
<li>Prompt 一改，回答跑偏，纯黑盒，只能回滚；</li>
<li>用户投诉“变慢了”，却找不到是哪一次模型调用拖了后腿；</li>
<li>老板问“新模型效果真的更好吗？” 额，不知道。</li>
</ul>
<p>直到把 Coze-Loop 加入到 Agent 中，终于实现了“像观测微服务一样观测 Agent”。</p>
<h1 id="2-是什么"><a href="#2-是什么" class="headerlink" title="2. 是什么"></a>2. 是什么</h1><p>一句话：字节 2025.7 开源的 <strong>AI Agent 生命周期管理平台，定位等价于“LLM 时代的 Prometheus + Grafana + JMeter”。</strong></p>
<table>
<thead>
<tr>
<th>模块</th>
<th>作用</th>
<th>类比传统中间件</th>
</tr>
</thead>
<tbody><tr>
<td>Prompt Playground</td>
<td>在线调试、版本 diff</td>
<td>Postman</td>
</tr>
<tr>
<td>评测中心</td>
<td>自动打分、回归测试</td>
<td>JMeter</td>
</tr>
<tr>
<td>全链路 Trace</td>
<td>每一次模型调用可追踪</td>
<td>Jaeger</td>
</tr>
<tr>
<td>实验管理</td>
<td>A&#x2F;B 切流、显著性检验</td>
<td>Flagr</td>
</tr>
<tr>
<td>监控大盘</td>
<td>Token 延迟、异常率</td>
<td>Grafana</td>
</tr>
</tbody></table>
<h1 id="3-核心能力拆解"><a href="#3-核心能力拆解" class="headerlink" title="3. 核心能力拆解"></a>3. 核心能力拆解</h1><ol>
<li>Prompt Playground：把“玄学”变“工程”</li>
</ol>
<p>支持 多模型并行对比（OpenAI&#x2F;Ark&#x2F;千帆&#x2F;通义&#x2F;Gemini&#x2F;Claude），一个输入六份输出，差异一眼可见 ；</p>
<p>每次调试自动生成 语义哈希，相同 Prompt 只存一份快照，节省 60% 空间；</p>
<p>一键“版本冻结”→ 生成 &#x2F;prompt&#x2F;v1.3.0 这样的只读端点，供线上服务通过 SDK 热加载，彻底告别“改完就回滚”。</p>
<ol start="2">
<li>系统化评测：让老板相信“新模型更好”</li>
</ol>
<p>数据集管理：支持 CSV、JSONL、飞书多维表，自动采样、去重、敏感词过滤；</p>
<p>评估器工厂：内置 BLEU、ROUGE、BERTScore、LLM-as-Judge（用更强的模型给弱模型打分）；</p>
<p>实验报告：自动计算↑↓变化率、p-value，红绿指标一键导出 PPT，老板再也不拍脑袋。</p>
<ol start="3">
<li>全链路 Trace：一次对话，一张瀑布图</li>
</ol>
<ul>
<li>自动解析 Prompt → 模型 → 工具 → 结果 四级跨度，瀑布图可直接下到 SQL；</li>
<li>与现有 Grafana 无缝打通，Token 延迟、异常率、限流次数 三合一大盘 。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kkb-1.github.io/2025/11/25/coze-loop/" data-id="cmie84po00000d0kdgdvn7cd5" data-title="coze loop" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aigc/" rel="tag">aigc</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-本地事件总线" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/10/31/%E6%9C%AC%E5%9C%B0%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BA%BF/" class="article-date">
  <time class="dt-published" datetime="2025-10-31T04:00:42.000Z" itemprop="datePublished">2025-10-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/10/31/%E6%9C%AC%E5%9C%B0%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BA%BF/">本地事件总线</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>在单体服务或边缘组件中，使用“本地事件总线”可以将核心交易流程与非关键但必要的“旁路逻辑”（如审计、埋点、异步落库等）解耦，同时在需要时以异步方式削峰。本文给出一个工程化的最小可用实现与实践要点。</p>
<h2 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h2><ul>
<li>非关键路径的“扩展逻辑”：埋点、通知、审计、缓存刷新、异步刷库等。</li>
<li>局部解耦：不引入外部 MQ 的情况下，让发布方不直接依赖消费者实现。</li>
<li>小成本削峰：在请求线程外异步执行，减少主流程时延。</li>
</ul>
<p>不适合的场景：需要跨进程&#x2F;跨服务可靠投递、严格有序性、可回溯性或高可用的强需求（此类应考虑 Kafka&#x2F;RabbitMQ&#x2F;事件流平台）。</p>
<h2 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h2><ul>
<li>简洁 API：注册、发布、选择同步&#x2F;异步。</li>
<li>并发安全：注册&#x2F;发布并发可用。</li>
<li>隔离性：消费者异常不影响发布方主流程。</li>
<li>可观测：最少限度的错误暴露与日志挂接点。</li>
</ul>
<h2 id="核心实现（线程安全、可选异步）"><a href="#核心实现（线程安全、可选异步）" class="headerlink" title="核心实现（线程安全、可选异步）"></a>核心实现（线程安全、可选异步）</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> eventbus</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件处理函数签名：按需自定义参数结构体</span></span><br><span class="line"><span class="keyword">type</span> HandlerFunc <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, arg1, arg2 MyStruct)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Bus <span class="keyword">struct</span> &#123;</span><br><span class="line">    mu       sync.RWMutex</span><br><span class="line">    handlers <span class="keyword">map</span>[<span class="type">string</span>]HandlerFunc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span></span> *Bus &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;Bus&#123;handlers: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]HandlerFunc)&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Register 注册事件处理器；重复注册将覆盖旧处理器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Bus)</span></span> Register(name <span class="type">string</span>, h HandlerFunc) &#123;</span><br><span class="line">    b.mu.Lock()</span><br><span class="line">    b.handlers[name] = h</span><br><span class="line">    b.mu.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Publish 发布事件；async=true 时在 goroutine 中执行</span></span><br><span class="line"><span class="comment">// 未注册的事件将返回 false 便于上层打点</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Bus)</span></span> Publish(ctx context.Context, name <span class="type">string</span>, arg1, arg2 MyStruct, async <span class="type">bool</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    b.mu.RLock()</span><br><span class="line">    h, ok := b.handlers[name]</span><br><span class="line">    b.mu.RUnlock()</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    run := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 防御：隔离消费者 panic，避免影响主流程</span></span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">                log.Printf(<span class="string">&quot;eventbus handler panic: name=%s, recover=%v&quot;</span>, name, r)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;()</span><br><span class="line">        h(ctx, arg1, arg2)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> async &#123;</span><br><span class="line">        <span class="keyword">go</span> run()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        run()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化总线</span></span><br><span class="line"><span class="keyword">var</span> bus = eventbus.New()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册：例如“异步刷盘 MySQL”</span></span><br><span class="line">bus.Register(<span class="string">&quot;async_flush_mysql&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, arg1, arg2 MyStruct)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 执行刷盘动作</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布：同步</span></span><br><span class="line">ok := bus.Publish(ctx, <span class="string">&quot;async_flush_mysql&quot;</span>, a1, a2, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">    <span class="comment">// 可记录未注册事件的观测日志</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布：异步</span></span><br><span class="line">_ = bus.Publish(ctx, <span class="string">&quot;async_flush_mysql&quot;</span>, a1, a2, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<h2 id="工程实践要点"><a href="#工程实践要点" class="headerlink" title="工程实践要点"></a>工程实践要点</h2><ul>
<li>错误与可观测：<ul>
<li>事件未注册时返回值用于统计&#x2F;告警。</li>
<li>建议在处理器内统一接入日志&#x2F;指标埋点，并结合 <code>context</code> 传递 traceID。</li>
</ul>
</li>
<li>上下文与超时：<ul>
<li>异步处理应尊重 <code>ctx</code>，在耗时操作处检查取消&#x2F;超时，避免后台 goroutine 漫游。</li>
</ul>
</li>
<li>并发与容量：<ul>
<li>如果异步任务可能堆积，增加限流&#x2F;队列（如带缓冲 channel + worker 池）。</li>
<li>长尾、重试、退避策略应在处理器内自行控制。</li>
</ul>
</li>
<li>Panic 隔离：<ul>
<li>已在 <code>Publish</code> 中加了 <code>recover</code>，仍建议处理器内做细粒度防御。</li>
</ul>
</li>
</ul>
<h2 id="与消息队列的对比"><a href="#与消息队列的对比" class="headerlink" title="与消息队列的对比"></a>与消息队列的对比</h2><ul>
<li>本地事件总线：轻量、零依赖、进程内调用，可靠性受制于进程生命周期，不具备跨服务投递保障。</li>
<li>专业 MQ&#x2F;事件流：具备持久化、回溯、重放、消费组、顺序与扩展性；成本与复杂度更高。</li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本地事件总线适合在单体或简易服务中对旁路逻辑进行解耦与异步化处理。通过线程安全的注册&#x2F;发布、panic 隔离与必要的可观测性，即可以极低成本获得显著的工程收益；当需求升级到跨服务可靠投递与大规模扩展时，再自然过渡到专业消息系统。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kkb-1.github.io/2025/10/31/%E6%9C%AC%E5%9C%B0%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BA%BF/" data-id="cmhebyoh90000w8kd08e5fcpl" data-title="本地事件总线" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/backend/" rel="tag">backend</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-AI-上下文工程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/10/27/AI-%E4%B8%8A%E4%B8%8B%E6%96%87%E5%B7%A5%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2025-10-27T06:58:43.000Z" itemprop="datePublished">2025-10-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/10/27/AI-%E4%B8%8A%E4%B8%8B%E6%96%87%E5%B7%A5%E7%A8%8B/">AI 上下文工程</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="长期记忆系统"><a href="#长期记忆系统" class="headerlink" title="长期记忆系统"></a>长期记忆系统</h1><h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><ul>
<li>元提示（框架）：<ul>
<li>向 llm 提问，让其回顾失败，生成摘要避免未来犯错</li>
</ul>
</li>
</ul>
<h2 id="观察"><a href="#观察" class="headerlink" title="观察"></a>观察</h2><ul>
<li>原始日志收集</li>
<li>合成日志<ul>
<li>让 llm 总结出新洞察</li>
</ul>
</li>
</ul>
<h2 id="选择"><a href="#选择" class="headerlink" title="选择"></a>选择</h2><ul>
<li>工具集<ul>
<li>使用 RAG 建立工具索引，这样子可以把最相关的 n 个加载进上下文而无需全部加载</li>
</ul>
</li>
<li>固定+遮蔽：<ul>
<li>通过复用 cv 缓存来加速</li>
</ul>
</li>
<li>混合检索<ul>
<li>多路召回：向量、关键词、知识图谱，多方面去获取信息</li>
<li>Agentic 探索： agent 在循环中，主动使用检索工具进行多步推理</li>
<li>重排序：把召回的数据进行二次总结，用更加精细的规则或模型去提高信噪比</li>
</ul>
</li>
</ul>
<h2 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h2><ul>
<li>上下文总结<ul>
<li>LLM 提炼<ul>
<li>总结对话历史（提炼成任务概览）</li>
<li>对海量的 API 返回结果总结成摘要</li>
</ul>
</li>
</ul>
</li>
<li>上下文裁剪<ul>
<li>丢弃信息<ul>
<li>滑动窗口（只保留最近n轮对话）</li>
<li>用轻量级的模型进行智能裁剪</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="微调-vs-上下文工程"><a href="#微调-vs-上下文工程" class="headerlink" title="微调 vs 上下文工程"></a>微调 vs 上下文工程</h1><ul>
<li>Manus 团队优先上下文工程发展</li>
</ul>
<h1 id="kv-缓存设计"><a href="#kv-缓存设计" class="headerlink" title="kv 缓存设计"></a>kv 缓存设计</h1><ul>
<li>kv 缓存工作机制<ul>
<li>前缀匹配</li>
</ul>
</li>
<li>提高缓存命中率的工程原则<ul>
<li>选用 vllm 这种能支持 kv 缓存功能的现代推理框架</li>
<li>缓存只存于同一个推理进程，所以需要用唯一标识来确保同一个会话请求打到同一个进程</li>
<li>保持前缀稳定</li>
<li>上下文只追加，不修改或删除中间部分</li>
<li>如果不支持自动前缀匹配的框架，需要手动插入断电来进行缓存</li>
</ul>
</li>
</ul>
<h1 id="工具选择"><a href="#工具选择" class="headerlink" title="工具选择"></a>工具选择</h1><blockquote>
<p>响应预填充</p>
</blockquote>
<p> 通过特定的前缀标签，为模型提前提供模式信号，引导他提前激活相应的模式</p>
<p><img src="/images/image9.png" alt="img"></p>
<h1 id="专注力"><a href="#专注力" class="headerlink" title="专注力"></a>专注力</h1><blockquote>
<p>todo.md</p>
</blockquote>
<ul>
<li>通过 write 工具在两个关键时机更新 todo.md<ul>
<li>复杂任务分解后写入</li>
<li>完成每个子任务就覆写最新进度</li>
</ul>
</li>
</ul>
<h1 id="反直觉"><a href="#反直觉" class="headerlink" title="反直觉"></a>反直觉</h1><p>将错误日志保留在上下文中，降低其重复犯错可能</p>
<h1 id="多-Agent-协作"><a href="#多-Agent-协作" class="headerlink" title="多 Agent 协作"></a>多 Agent 协作</h1><ul>
<li>通信<ul>
<li>上下文不共享，子 agent 只处理原子性子任务</li>
</ul>
</li>
<li>共享上下文<ul>
<li>类似于 fork </li>
<li>子 agent 拥有主 agent 全部历史＋子 agent 新 system prompt</li>
</ul>
</li>
</ul>
<h1 id="三层工具"><a href="#三层工具" class="headerlink" title="三层工具"></a>三层工具</h1><ul>
<li>极少数、固定的原子函数</li>
<li>能力扩展，通过第一层的原子函数（execute_shell）调用获得外部动态工具箱</li>
<li>组合使用第一层和第二层编写并执行脚本</li>
</ul>
<h1 id="处理大型工具输出"><a href="#处理大型工具输出" class="headerlink" title="处理大型工具输出"></a>处理大型工具输出</h1><ul>
<li>创建子 agent 去提炼，只返回固定的、结构化的结果。（就是一层层套娃，直到套娃到原子行为）</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kkb-1.github.io/2025/10/27/AI-%E4%B8%8A%E4%B8%8B%E6%96%87%E5%B7%A5%E7%A8%8B/" data-id="cmheib4rz0000xckd2suy22di" data-title="AI 上下文工程" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aigc/" rel="tag">aigc</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-mcp-协议理解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/15/mcp-%E5%8D%8F%E8%AE%AE%E7%90%86%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2025-09-15T02:20:11.000Z" itemprop="datePublished">2025-09-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/15/mcp-%E5%8D%8F%E8%AE%AE%E7%90%86%E8%A7%A3/">mcp 协议理解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ol>
<li><h1 id="Mcp-协议分析"><a href="#Mcp-协议分析" class="headerlink" title="Mcp 协议分析"></a>Mcp 协议分析</h1></li>
</ol>
<p>整个 Mcp ，无论是 Stdio 、 Sse 、Streamable ，只要遵守对应的 JSONRPC 请求和响应格式，即使你实际上只是一个空壳，大模型依然会相信你是个 Mcp 。</p>
<ol>
<li><h2 id="Stdio"><a href="#Stdio" class="headerlink" title="Stdio"></a>Stdio</h2></li>
</ol>
<p>Stdio 实际上是本地执行命令。</p>
<ul>
<li>举个例子，假设你本地有一个 exe 文件，路径是：C:&#x2F;&#x2F;User&#x2F;test.exe (路径我乱编的，格式可能有一点点错误，补药太在意哈)，那么你的 Stdio Mcp 的 Command 选项就可以填 C:&#x2F;&#x2F;User&#x2F;test.exe ，至于 Args 这个看你这个 exe 要不要，其实就是 -h 那些，而 Env 这个就是环境变量，配 C 语言环境的那个环境。</li>
<li>为什么 Cherry Stdio 使用不需要我自己配环境？我没有深究过，但是基本可以确定 Cherry Stdio 提供了一个会话，这个会话中的环境变量被 Cherry Stdio 配过，所以只影响当前会话，而不会永久影响你的电脑环境配置。</li>
<li>整个过程<ul>
<li>大模型通知 Cherry Stdio 我要用这个 Mcp ，包括对应的参数什么的</li>
<li>Cherry Stdio 收到消息，执行 exe 并在与 exe 的标准输入中输入 JSONRPC 消息 </li>
<li>Exe 从标准输入流中获取信息并处理后返回一个 JSONRPC 消息，输出到标准输出里</li>
<li>Cherry Stdio 拿到数据，喂给大模型</li>
<li>大模型根据新消息再吐出最终结果</li>
</ul>
</li>
</ul>
<blockquote>
<p>参考的 JSONRPC 请求和响应数据</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">req<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span><span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span><span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;initialize&quot;</span><span class="punctuation">,</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;params&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;roots&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;listChanged&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;sampling&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;clientInfo&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;mcp-inspector&quot;</span><span class="punctuation">,</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="string">&quot;0.14.0&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span><span class="string">&quot;2025-03-26&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">res<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span><span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;result&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span><span class="string">&quot;2024-11-05&quot;</span><span class="punctuation">,</span><span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;prompts&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;resources&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;tools&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;serverInfo&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;markitdown&quot;</span><span class="punctuation">,</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="string">&quot;1.8.1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><h2 id="Sse"><a href="#Sse" class="headerlink" title="Sse"></a>Sse</h2></li>
</ol>
<p>Sse 骚操作有点多，他输入和输出不是同一个接口，也就是说他由两个接口组成一个完整的输入输出，类似下面</p>
<p><img src="/images/image.png" alt="img"></p>
<ul>
<li>sse 端点:<ul>
<li>用于向客户端发消息，这个端点接口会持续存在，符合 sse 协议，持续吐消息</li>
</ul>
</li>
<li>messages<ul>
<li>用于接收客户端的消息，一次请求为一次接收，消息处理的结果会从 sse 端点那里吐出</li>
</ul>
</li>
<li>整个过程<ul>
<li>请求 sse 端点， sse 端点会返回一个 endpoint 消息，里面包含了 messages 端点路径和分配的 sessionid ，至于前面的域名什么的，约定与 sse 端点的域名保持一致（<a href="http://127.0.0.1:8094）">http://127.0.0.1:8094）</a></li>
<li><img src="/images/image%20(1).png" alt="img"></li>
<li>向 messages 端点发送初始化消息，messages 端点只会响应一个 accepted</li>
<li><img src="/images/image%20(2).png" alt="img"></li>
<li><img src="/images/image%20(3).png" alt="img"></li>
<li>此时 sse 端点会得到 server 返回的信息</li>
<li><img src="/images/image%20(4).png" alt="img"></li>
<li>包括 tool call 也是一样的</li>
<li><img src="/images/image%20(5).png" alt="img"></li>
<li><img src="/images/image%20(6).png" alt="img"></li>
</ul>
</li>
</ul>
<ol>
<li><h2 id="Streamable"><a href="#Streamable" class="headerlink" title="Streamable"></a>Streamable</h2></li>
</ol>
<p>比起 sse 好一点，没那么精神分裂，非要搞两个接口，一个接口就完事了,实际上我个人感觉跟普通的 http 接口没啥区别，也就多了一些约定</p>
<blockquote>
<p>约定</p>
</blockquote>
<ul>
<li>请求<ul>
<li>Header<ul>
<li>Mcp-Session-Id sessionid 存在这里，用于告诉服务端听复用之前的信息</li>
<li>Accept 默认 application&#x2F;json, text&#x2F;event-stream</li>
</ul>
</li>
</ul>
</li>
<li>响应<ul>
<li>Header<ul>
<li>Mcp-Session-Id 把 服务端分配的 sessionid 交给客户端</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>其他跟正常 http 请求没区别，只是请求响应 json 格式有固定要求而已</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">req<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span><span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span><span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;initialize&quot;</span><span class="punctuation">,</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;params&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;roots&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;listChanged&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;sampling&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;clientInfo&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;mcp-inspector&quot;</span><span class="punctuation">,</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="string">&quot;0.14.0&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span><span class="string">&quot;2025-03-26&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">res<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span><span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;result&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span><span class="string">&quot;2024-11-05&quot;</span><span class="punctuation">,</span><span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;prompts&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;resources&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;tools&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;serverInfo&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;markitdown&quot;</span><span class="punctuation">,</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="string">&quot;1.8.1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>过程展示<ul>
<li>这里就不展示了，就是一次请求一次响应信息，首次请求会在 header 中返回 sessionid ，之后的每次请求都带上这个 sessionid 以此保持会话状态。</li>
<li>下面这个是我的 streamable 接口处理的一小部分代码，已经可以说明上面的约定了</li>
</ul>
</li>
</ul>
<p><img src="/images/image%20(7).png" alt="img"></p>
<p><img src="/images/image%20(8).png" alt="img"></p>
<ol>
<li><h1 id="Mcp-请求响应分析"><a href="#Mcp-请求响应分析" class="headerlink" title="Mcp 请求响应分析"></a>Mcp 请求响应分析</h1></li>
</ol>
<p>众所周知， Mcp 的请求响应都遵守了一个约定，字段名什么的都约定好了。</p>
<ol>
<li><h2 id="请求"><a href="#请求" class="headerlink" title="请求"></a>请求</h2></li>
</ol>
<p>这里可以看出来，以下约定：</p>
<ul>
<li>必须携带 jsonrpc 字段，一般是 2.0</li>
<li>method ：根据实际想干嘛来提供对应的 method</li>
<li>id :每次请求叠加 1 ，初始为 0</li>
<li>params ：根据 method 的不同也不同，对应 go 中的 interface{}</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;initialize&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;roots&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;listChanged&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sampling&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;clientInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mcp-inspector&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.14.0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-03-26&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// tool call</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tools/call&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_meta&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;progressToken&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arguments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://aitoken-public.qnaigc.com/test/transformer.pdf&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;convert_to_markdown&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// tool list</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tools/list&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_meta&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;progressToken&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><h2 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h2></li>
</ol>
<blockquote>
<p>约定</p>
</blockquote>
<ul>
<li>必须携带 jsonrpc 字段，一般是 2.0</li>
<li>id :请求给啥返回啥</li>
<li>result:  客户端真正想要的数据，一样是 interface{}</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-11-05&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;prompts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;resources&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;tools&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;serverInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;markitdown&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.8.1&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// tool call</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span><span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;。。。。&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// tool list</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;tools&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;annotations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Convert a resource described by an http:, https:, file: or data: URI to markdown&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;inputSchema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Uri&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="string">&quot;uri&quot;</span></span><br><span class="line">                    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;convert_to_markdown&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><h2 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h2></li>
</ol>
<p>这个好像很全：<a target="_blank" rel="noopener" href="https://modelcontextprotocol.info/zh-cn/">https://modelcontextprotocol.info/zh-cn/</a></p>
<p>每个 method 都有对应的确认的 params 格式和 result 格式，可以看我下面提供的例子里看他的 params 和 result 长啥样。</p>
<p>目前我知道的 method 分为了以下几个：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    Initialize               = <span class="string">&quot;initialize&quot;</span></span><br><span class="line">    Ping                     = <span class="string">&quot;ping&quot;</span></span><br><span class="line">    ResourcesList            = <span class="string">&quot;resources/list&quot;</span></span><br><span class="line">    ResourcesTemplatesList   = <span class="string">&quot;resources/templates/list&quot;</span></span><br><span class="line">    ResourcesRead            = <span class="string">&quot;resources/read&quot;</span></span><br><span class="line">    ResourcesSubscribe       = <span class="string">&quot;resources/subscribe&quot;</span></span><br><span class="line">    ResourcesUnsubscribe     = <span class="string">&quot;resources/unsubscribe&quot;</span></span><br><span class="line">    PromptsList              = <span class="string">&quot;prompts/list&quot;</span></span><br><span class="line">    PromptsGet               = <span class="string">&quot;prompts/get&quot;</span></span><br><span class="line">    ToolsList                = <span class="string">&quot;tools/list&quot;</span></span><br><span class="line">    ToolsCall                = <span class="string">&quot;tools/call&quot;</span></span><br><span class="line">    LoggingSetLevel          = <span class="string">&quot;logging/setLevel&quot;</span></span><br><span class="line">    CompletionComplete       = <span class="string">&quot;completion/complete&quot;</span></span><br><span class="line">    NotificationsInitialized = <span class="string">&quot;notifications/initialized&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="initialize"><a href="#initialize" class="headerlink" title="initialize"></a>initialize</h3></li>
</ol>
<p>在客户端正式启动之前，需要一个激活操作，也就是客户端往服务端发送 initialize 消息，告知服务端，客户端的身份，服务端会分配一个 sessionid 给客户端，之后的聊天就依据 sessionid 知道你是谁。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">req<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;initialize&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;roots&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;listChanged&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sampling&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;clientInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mcp-inspector&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.14.0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-03-26&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">res<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-11-05&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;prompts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;resources&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;tools&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;serverInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;markitdown&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.8.1&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3></li>
</ol>
<p>就是 ping 一下看你还活不活着</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">req<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ping&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_meta&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;progressToken&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">res<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="resources-list"><a href="#resources-list" class="headerlink" title="resources&#x2F;list"></a>resources&#x2F;list</h3></li>
</ol>
<p>不知道能干啥</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">req<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;resources/list&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_meta&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;progressToken&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">res<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;resources&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="resources-templates-list"><a href="#resources-templates-list" class="headerlink" title="resources&#x2F;templates&#x2F;list"></a>resources&#x2F;templates&#x2F;list</h3></li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">req<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;resources/templates/list&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_meta&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;progressToken&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">res<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;resourceTemplates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="resources-read"><a href="#resources-read" class="headerlink" title="resources&#x2F;read"></a>resources&#x2F;read</h3></li>
</ol>
<p>没用过</p>
<ol>
<li><h3 id="resources-subscribe"><a href="#resources-subscribe" class="headerlink" title="resources&#x2F;subscribe"></a>resources&#x2F;subscribe</h3></li>
</ol>
<p>没用过</p>
<ol>
<li><h3 id="resources-unsubscribe"><a href="#resources-unsubscribe" class="headerlink" title="resources&#x2F;unsubscribe"></a>resources&#x2F;unsubscribe</h3></li>
</ol>
<p>没用过</p>
<ol>
<li><h3 id="prompts-list"><a href="#prompts-list" class="headerlink" title="prompts&#x2F;list"></a>prompts&#x2F;list</h3></li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">req<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prompts/list&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_meta&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;progressToken&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">res<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;prompts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="prompts-get"><a href="#prompts-get" class="headerlink" title="prompts&#x2F;get"></a>prompts&#x2F;get</h3></li>
</ol>
<p>没用过</p>
<ol>
<li><h3 id="tools-list"><a href="#tools-list" class="headerlink" title="tools&#x2F;list"></a>tools&#x2F;list</h3></li>
</ol>
<p>列出工具</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">req:&#123;</span><br><span class="line">    <span class="string">&quot;jsonrpc&quot;</span>: <span class="string">&quot;2.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;method&quot;</span>: <span class="string">&quot;tools/list&quot;</span>,</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="string">&quot;params&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;_meta&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;progressToken&quot;</span>: <span class="number">4</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res:&#123;</span><br><span class="line">    <span class="string">&quot;jsonrpc&quot;</span>: <span class="string">&quot;2.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="string">&quot;result&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;tools&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;annotations&quot;</span>: &#123;&#125;,</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Convert a resource described by an http:, https:, file: or data: URI to markdown&quot;</span>,</span><br><span class="line">                <span class="string">&quot;inputSchema&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;uri&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Uri&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;required&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;uri&quot;</span></span><br><span class="line">                    ],</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;convert_to_markdown&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="tools-call"><a href="#tools-call" class="headerlink" title="tools&#x2F;call"></a>tools&#x2F;call</h3></li>
</ol>
<p>执行工具</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">req<span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tools/call&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_meta&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;progressToken&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arguments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://aitoken-public.qnaigc.com/test/transformer.pdf&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;convert_to_markdown&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res<span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span><span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;。。。。&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="logging-setLevel"><a href="#logging-setLevel" class="headerlink" title="logging&#x2F;setLevel"></a>logging&#x2F;setLevel</h3></li>
</ol>
<p>没用过</p>
<ol>
<li><h3 id="completion-complete"><a href="#completion-complete" class="headerlink" title="completion&#x2F;complete"></a>completion&#x2F;complete</h3></li>
</ol>
<p>没用过</p>
<ol>
<li><h3 id="notifications-initialized"><a href="#notifications-initialized" class="headerlink" title="notifications&#x2F;initialized"></a>notifications&#x2F;initialized</h3></li>
</ol>
<p>这个有点东西，动不动发一个的，但是你不用回复</p>
<ol>
<li><h1 id="Mcp-与-Eino"><a href="#Mcp-与-Eino" class="headerlink" title="Mcp 与 Eino"></a>Mcp 与 Eino</h1></li>
</ol>
<blockquote>
<p>Eino</p>
</blockquote>
<p>是字节研发的一款大模型二开框架</p>
<blockquote>
<p>Eino 是怎么用 Mcp 的（参考 react agent）</p>
</blockquote>
<ul>
<li>对于 Eino 而言， Mcp 被视为了一个 Tool ，所以通过 Eino 让大模型调用 Mcp 就变成了：<ul>
<li>Eino 告诉大模型有这些 Tool</li>
<li>大模型通过 tool_calls 通知 Eino 调用对应的 Mcp</li>
<li>Eino 将 Mcp 调用结果重新“投喂”给大模型</li>
<li>大模型根据上下文再说出最终的结果</li>
</ul>
</li>
</ul>
<blockquote>
<p>如何将 Eino 隐藏起来的对话消耗 Token 拿到手</p>
</blockquote>
<p>从上面描述可以得知，Eino 最终吐出的消息在背地里是经过了 n 次对话产生的</p>
<ol>
<li><h1 id="学习资料"><a href="#学习资料" class="headerlink" title="学习资料"></a>学习资料</h1></li>
</ol>
<ul>
<li>mcp （server or client） go 版：</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/mark3labs/mcp-go">https://github.com/mark3labs/mcp-go</a></p>
<ul>
<li>mcp 流量转发：</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/kkb-1/mcprouter">https://github.com/kkb-1/mcprouter</a></p>
<ul>
<li>mcp 调试工具（ F12 看他的网络请求，了解 mcp 实际协议干了啥）：</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://mcp-docs.cn/docs/tools/inspector">https://mcp-docs.cn/docs/tools/inspector</a></p>
<ul>
<li>mcp proxy（协议转换，例如 stdio 转 sse ，这个会用就行）：</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/sparfenyuk/mcp-proxy">https://github.com/sparfenyuk/mcp-proxy</a></p>
<ul>
<li>eino （字节的 cloudwego 系列，大模型二开框架）：</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.cloudwego.io/zh/docs/eino/ecosystem_integration/tool/tool_mcp/">https://www.cloudwego.io/zh/docs/eino/ecosystem_integration/tool/tool_mcp/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kkb-1.github.io/2025/09/15/mcp-%E5%8D%8F%E8%AE%AE%E7%90%86%E8%A7%A3/" data-id="cmfkibqkf0000vhkd1csb81q7" data-title="mcp 协议理解" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aigc/" rel="tag">aigc</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-如何快速上手一个项目（后端）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/04/04/%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E4%B8%80%E4%B8%AA%E9%A1%B9%E7%9B%AE%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2025-04-04T14:38:53.000Z" itemprop="datePublished">2025-04-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/04/04/%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E4%B8%80%E4%B8%AA%E9%A1%B9%E7%9B%AE%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89/">如何快速上手一个项目（后端）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ol>
<li>要项目拉取权限<br>这一点虽然很废话，但是你刚来就敢主动找 mt 要项目不？</li>
<li>有没有开发规范和接口文档？<br>问 mt 要一个看，如果没有那也没事，有的话会更方便你后续开发</li>
<li>寻找 main</li>
</ol>
<ul>
<li>main 是运行代码的入口，只有找到了它，你才能开始后续的操作</li>
<li>一般来说 main 中会包含：<ul>
<li>配置初始化</li>
<li>定时任务启动（当然，一般一个已经稳定的项目，它的定时任务是分离出去的）</li>
<li>创建 web 服务器</li>
</ul>
</li>
</ul>
<ol start="4">
<li>快速熟悉项目代码风格</li>
</ol>
<ul>
<li>先寻找 router ，在 router 中寻找一个你认为分离得比较成功的路由小模块</li>
<li>看路由写法</li>
<li>随机找一个接口进去看</li>
<li>如果你有开发规范文档，那么就可以结合着文档了解他们的接口名、函数名、变量名、结构体名这些命名规范</li>
<li>看它是怎么使用 log 、 db 和 cache 的</li>
<li>如何处理错误，错误应该如何构建</li>
<li>常量是放在哪里的？</li>
<li>好了，现在回过头来看一下，你一路追下来的文件的文件夹层是怎么个分布法（恭喜，你已经会写一个符合团队风格的接口了）</li>
<li>寻找 config ，你只有一个任务，它是怎么读配置的</li>
</ul>
<ol start="5">
<li>同步业务信息</li>
</ol>
<ul>
<li>直接看 git 提交记录，等同于爬楼看聊天记录一样，如果前者的 commit 写得正常点，你就能快速看懂它在干嘛</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kkb-1.github.io/2025/04/04/%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E4%B8%80%E4%B8%AA%E9%A1%B9%E7%9B%AE%EF%BC%88%E5%90%8E%E7%AB%AF%EF%BC%89/" data-id="cm92w4yzj00032ekdg37bc144" data-title="如何快速上手一个项目（后端）" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/backend/" rel="tag">backend</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-第三方支付接入-stripe为例" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/04/04/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%94%AF%E4%BB%98%E6%8E%A5%E5%85%A5-stripe%E4%B8%BA%E4%BE%8B/" class="article-date">
  <time class="dt-published" datetime="2025-04-04T14:37:39.000Z" itemprop="datePublished">2025-04-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/04/04/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%94%AF%E4%BB%98%E6%8E%A5%E5%85%A5-stripe%E4%B8%BA%E4%BE%8B/">第三方支付接入(stripe为例)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ol>
<li>开启交易会话<ol>
<li>使用平台提供的私钥，向平台的创建交易会话的接口发起请求，生成一个交易链接，需要提供价格ID、商品数量、成功支付重定向链接、取消支付重定向链接等自定义参数</li>
<li>价格ID：价格在stripe中是一个概念实体，比如你有一个VIP服务商品，可以一次性开通一个月，也可以连续包月，那这个商品就有两个价格了，每个价格的单价与结算方式是不一样的，同时每个价格都有唯一的ID，即价格ID</li>
</ol>
</li>
<li>事件监听<br>  【背景】用户的支付是在第三方平台完成的，对于我们服务端来说是无感知的，即你无法直接得知用户是否付完钱、哪个用户付了哪一笔钱。所以你需要向第三方平台订阅这个消息，这个订阅也叫做事件监听<ol>
<li>创建服务端事件回调接口：当第三方平台想要向服务端发送消息时，就会把消息发送到事件回调接口，事件回调接口接收消息并正确处理消息（包括：将订单状态转为成功支付）</li>
<li>注册第三方事件监听：在第三方注册自己的回调接口以及需要触发回调的事件类型</li>
<li>事件成功监听：第三方与服务端会约定一个规则来确认是否服务端成功接收并处理事件，例如服务端成功接收并处理事件就返回200状态码</li>
<li>事件重发行为：由于网络环境复杂，不能确保发一次消息就能成功，所以一般第三方会有不断重发的行为逻辑，知道得到服务端的确认（例如：200状态码）</li>
<li>事件监听的不可信：不论是网络问题还是第三方平台服务崩溃问题，都有可能导致消息发送失败，并且支付可能有延迟完成的情况（比如银行走流程确认转帐什么的），所以第三方支付一般不保证事件实时发送给服务端</li>
<li>事件鉴权：与第三方约定好一个鉴权机制，确保请求事件监听回调接口的是第三方</li>
</ol>
</li>
<li>最终方案<ol>
<li>发起交易会话的同时，生成一个订单ID，与会话ID结合加密生成一个新ID</li>
<li>支付成功重定向的网址拿会话ID请求事件回调接口，事件回调接口发现无法通过strip的鉴权，认为是重定向的请求，此时向strip发起请求确认交易会话状态</li>
<li>为了防止支付成功并重定向那一刻服务端崩溃，以事件监听作为兜底机制</li>
<li>strip请求事件回调接口，通过strip的鉴权，可以信任strip发来的事件状态，也可以不信任，重新向strip发起请求确认交易会话状态</li>
<li>总体采用状态机模式</li>
<li>确认订单状态，完成订单</li>
</ol>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kkb-1.github.io/2025/04/04/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%94%AF%E4%BB%98%E6%8E%A5%E5%85%A5-stripe%E4%B8%BA%E4%BE%8B/" data-id="cm92w4yzj00052ekdgrab2wr8" data-title="第三方支付接入(stripe为例)" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/backend/" rel="tag">backend</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-docker-文件系统" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/04/04/docker-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" class="article-date">
  <time class="dt-published" datetime="2025-04-04T14:34:47.000Z" itemprop="datePublished">2025-04-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/04/04/docker-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">docker 文件系统</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>联合文件系统</p>
</blockquote>
<p>联合文件系统（Union File System）UnionFS是docker制作镜像和容器文件的主要技术。通过联合文件系统，可以将多个路径挂载到同一个挂载点上，实现多个path的合并操作（上层同名文件会将下层文件覆盖），最后通过挂载点想上层应用&#x2F;用户呈现一个合并之后的视图，联合文件系统有多种实现，ubuntu采用AUFS实现，centos采用overlay&#x2F;overlay2来实现。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kkb-1.github.io/2025/04/04/docker-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" data-id="cm92w4yzi00012ekd592na202" data-title="docker 文件系统" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-docker-pull-断点续传" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/04/04/docker-pull-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0/" class="article-date">
  <time class="dt-published" datetime="2025-04-04T14:34:39.000Z" itemprop="datePublished">2025-04-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/04/04/docker-pull-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0/">docker pull 断点续传</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li>随着技术和业务不断迭代，镜像层不断叠加，会出现非常大的镜像，以默认的docker配置拉取的话，网络一旦波动就会前功尽弃，这其实是非常灾难性的情况</li>
<li>docker可以通过在配置文件中添加👇的配置内容，重启docker后就可以支持断点续传</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="attr">&quot;features&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"> <span class="attr">&quot;containerd-snapshotter&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>断点续传配置生效后，docker原有的镜像将无法识别，也就是假性清空，可以把断点续传配置取消，镜像就又能识别了</li>
</ul>
<blockquote>
<p>原理</p>
</blockquote>
<ul>
<li>docker断点续传本质是不断对拉取的镜像层打“快照”，如果你有一次突然中断了拉取，再次进行拉取时，docker会取出快照，接着原来的进度继续拉取，所以断点续传会产生较多的冗余数据，占空间</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kkb-1.github.io/2025/04/04/docker-pull-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0/" data-id="cm92w4yzg00002ekd05dhgjn5" data-title="docker pull 断点续传" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/aigc/" rel="tag">aigc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aigc-backend/" rel="tag">aigc backend</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ai%E6%8F%90%E6%95%88/" rel="tag">ai提效</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/backend/" rel="tag">backend</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cicd/" rel="tag">cicd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/aigc/" style="font-size: 15px;">aigc</a> <a href="/tags/aigc-backend/" style="font-size: 10px;">aigc backend</a> <a href="/tags/ai%E6%8F%90%E6%95%88/" style="font-size: 10px;">ai提效</a> <a href="/tags/backend/" style="font-size: 20px;">backend</a> <a href="/tags/cicd/" style="font-size: 10px;">cicd</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/12/">十二月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/11/">十一月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/10/">十月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/09/">九月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">四月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">九月 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/12/05/%E5%87%8F%E5%B0%91%E5%B7%A5%E5%85%B7-token-%E6%93%8D%E4%BD%9C/">减少工具 token 操作</a>
          </li>
        
          <li>
            <a href="/2025/11/26/%E5%9F%BA%E4%BA%8E-AGUI-%E5%92%8C-MCP-%E5%AE%9E%E7%8E%B0%E7%AB%AF-Tool/">基于 AGUI 和 MCP 实现端 Tool</a>
          </li>
        
          <li>
            <a href="/2025/11/25/coze-loop/">coze loop</a>
          </li>
        
          <li>
            <a href="/2025/10/31/%E6%9C%AC%E5%9C%B0%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BA%BF/">本地事件总线</a>
          </li>
        
          <li>
            <a href="/2025/10/27/AI-%E4%B8%8A%E4%B8%8B%E6%96%87%E5%B7%A5%E7%A8%8B/">AI 上下文工程</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 kkb<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>